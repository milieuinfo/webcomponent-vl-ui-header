<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <script src="../../node_modules/sinon/pkg/sinon.js"></script>
</head>

<body>
  <test-fixture id="vl-header-fixture">
    <template>
      <vl-header data-vl-identifier="59188ff6-662b-45b9-b23a-964ad48c2bfb"></vl-header>
    </template>
  </test-fixture>

  <test-fixture id="vl-header-development-fixture">
    <template>
      <vl-header data-vl-identifier="59188ff6-662b-45b9-b23a-964ad48c2bfb" data-vl-development></vl-header>
    </template>
  </test-fixture>

  <script type="module">
    import fetchMock from 'fetch-mock/esm/client.mjs';
    import { VlHeader } from '../../src/vl-header.js';

    suite('vl-header', () => {
      const should = chai.should();
      const sandbox = sinon.createSandbox();
      const url = 'https://prod.widgets.burgerprofiel.vlaanderen.be/api/v1/widget/59188ff6-662b-45b9-b23a-964ad48c2bfb/embed';
      const devUrl = 'https://tni.widgets.burgerprofiel.dev-vlaanderen.be/api/v1/widget/59188ff6-662b-45b9-b23a-964ad48c2bfb/embed';

      setup((done) => {
        customElements.whenDefined('vl-header').then(() => done());
      });

      teardown(() => {
        sandbox.restore();
        fetchMock.restore();
      });

      test('haalt de Webuniversum embed code op, voorziet een placholder en voert de code uit', () => {
        const message = 'code werd uitgevoerd!';
        fetchMock.mock(url, 'console.log("' + message + '")');
        const header = fixture('vl-header-fixture');
        sandbox.spy(console, 'log');
        should.not.exist(document.body.querySelector('#' + VlHeader.id));
        return fetchMock.flush(true).then(() => {
          should.exist(document.body.querySelector('#' + VlHeader.id));
          assert(console.log.calledWith(message));
        });
      });

      test('toont een console foutmelding wanneer het ophalen van de Webuniversum embed code niet lukt', () => {
        fetchMock.mock(url, 404);
        const header = fixture('vl-header-fixture');
        sandbox.spy(console, 'error');
        return fetchMock.flush().then(() => {
          assert(console.error.called);
        });
      });

      test('indien het development attribuut aanwezig is zal de development AIV server aangesproken worden', () => {
        const mock = fetchMock.mock(devUrl, 200);
        fixture('vl-header-development-fixture');
        return fetchMock.flush().then(() => {
          assert.isFalse(mock.called(url));
          assert.isTrue(mock.called(devUrl));
        });
      });
    });
  </script>
</body>

</html>